<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>스킬 계산기 (고급형)</title>
  <style>
    body {
      font-family: "나눔고딕", sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background: #f7f7f7;
      color: #222;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark {
      background: #121212;
      color: #eee;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="number"] {
      width: 220px;
      padding: 5px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark input[type="text"],
    body.dark input[type="number"] {
      background-color: #222;
      border-color: #444;
      color: #eee;
    }
    .section {
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 20px;
      background: #fff;
      border-radius: 10px;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark .section {
      background: #1e1e1e;
      border-color: #444;
    }
    .result {
      font-size: 1.1em;
      margin-top: 10px;
      white-space: pre-wrap;
      background: #eee;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark .result {
      background: #333;
      border-color: #666;
    }
    .switch {
      margin-top: 10px;
    }
    button {
      padding: 10px 20px;
      margin-top: 15px;
      border: none;
      background: #4a90e2;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    button:hover {
      background: #357abd;
    }
    .btn-group {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    .dark-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      cursor: pointer;
      background: #4a90e2;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    .dark-toggle:hover {
      background: #357abd;
    }
  </style>
</head>
<body>
  <button class="dark-toggle" onclick="toggleDarkMode()">다크모드 토글</button>

  <h1>스킬 계산기 (고급형)</h1>

  <div class="section">
    <h2>입력값</h2>
    <label>기초 공격력: <input type="number" id="baseAtk" /></label>
    <label>깡 공격력: <input type="number" id="flatAtk" /></label>
    <label>공격력%: <input type="text" id="atkPercent" placeholder="예: 25%" /></label>
    <label>기초 스킬 데미지 계수: <input type="number" id="baseSkill" /></label>
    <label>추가 스킬 데미지 계수: <input type="number" id="bonusSkill" /></label>
    <label>치명타 확률%: <input type="text" id="critRate" placeholder="예: 50%" /></label>
    <label>치명타 피해%: <input type="text" id="critDmg" placeholder="예: 75%" /></label>
    <label>저주%: <input type="text" id="curse" placeholder="예: 30%" /></label>
    <label>감전%: <input type="text" id="shock" placeholder="예: 20%" /></label>
    <label>추가 피해%: <input type="text" id="extraDmg" placeholder="예: 10%" /></label>
    <label>적중 시 피해: <input type="text" id="onHit" placeholder="상수 혹은 % (예: 200 또는 20%)" /></label>
    <label>기본 기술 피해량 증가%: <input type="text" id="basicSkillBoost" placeholder="예: 15%" /></label>
    <label>출혈 데미지%: <input type="text" id="bleedDmg" placeholder="예: 50%" /></label>
    <label>출혈 내성%: <input type="text" id="bleedResist" placeholder="예: 10%" /></label>
    <label>출혈 중첩 수: <input type="number" id="bleedStack" min="0" /></label>
    <label>자상 데미지: <input type="text" id="stabDmg" placeholder="상수 혹은 % (예: 300 또는 30%)" /></label>

    <div class="switch">
      <label><input type="checkbox" id="brand" /> 낙인 있음 (1.2배)</label>
      <label><input type="checkbox" id="hiddenBlade" /> 숨겨진 칼날 유물 있음</label>
    </div>

    <div class="btn-group">
      <button onclick="calculate()">계산하기</button>
      <button onclick="saveInputs()">입력값 저장</button>
      <button onclick="loadInputs()">입력값 불러오기</button>
      <button onclick="clearInputs()">초기화</button>
    </div>
  </div>

  <div class="section">
    <h2>계산 결과</h2>
    <div class="result" id="result">계산 결과가 여기에 표시됩니다.</div>
    <div class="result" id="formula" style="margin-top:15px; font-size:0.9em; color:#555;"></div>
  </div>

  <script>
    // 다크모드 토글
    function toggleDarkMode() {
      document.body.classList.toggle("dark");
    }

    // %인지 상수인지 파싱 (null 반환 가능)
    function parsePercentOrConst(value) {
      if (!value) return null;
      value = value.trim();
      if (value.endsWith("%")) {
        return 1 + parseFloat(value) / 100;
      }
      return parseFloat(value);
    }

    // %값만 추출 (숫자만 반환)
    function parsePercentValue(value) {
      if (!value) return null;
      value = value.trim();
      if (value.endsWith("%")) {
        return parseFloat(value);
      }
      return null;
    }

    // 숫자 또는 null 반환
    function parseNumber(value) {
      if (!value) return null;
      let num = parseFloat(value);
      if (isNaN(num)) return null;
      return num;
    }

    function calculate() {
      const baseAtk = parseNumber(document.getElementById("baseAtk").value) || 0;
      const flatAtk = parseNumber(document.getElementById("flatAtk").value) || 0;
      const atkPercentRaw = document.getElementById("atkPercent").value;
      const atkPercent = parsePercentOrConst(atkPercentRaw) || 1;

      const baseSkill = parseNumber(document.getElementById("baseSkill").value) || 0;
      const bonusSkill = parseNumber(document.getElementById("bonusSkill").value) || 0;

      const critRateRaw = parseNumber(document.getElementById("critRate").value) || 0;
      const critDmgRaw = document.getElementById("critDmg").value;
      const critDmg = parsePercentOrConst(critDmgRaw) || 1;

      const curseRaw = document.getElementById("curse").value;
      const curse = parsePercentOrConst(curseRaw) || 1;

      const shockRaw = document.getElementById("shock").value;
      const shock = parsePercentOrConst(shockRaw) || 1;

      const extraDmgRaw = document.getElementById("extraDmg").value;
      const extraDmg = parsePercentOrConst(extraDmgRaw) || 1;

      const onHitRaw = document.getElementById("onHit").value.trim();
      let onHit = 0;
      if (onHitRaw.endsWith("%")) {
        onHit = (1 + parseFloat(onHitRaw) / 100) - 1; // %형태는 피해량에 더하는 상수로 처리
      } else if (onHitRaw !== "") {
        onHit = parseFloat(onHitRaw);
      }

      const basicSkillBoostRaw = document.getElementById("basicSkillBoost").value;
      const basicSkillBoost = parsePercentOrConst(basicSkillBoostRaw) || 1;

      const bleedDmgRaw = document.getElementById("bleedDmg").value;
      const bleedDmg = parsePercentOrConst(bleedDmgRaw) || 1;

      const bleedResistRaw = document.getElementById("bleedResist").value;
      const bleedResist = parsePercentOrConst(bleedResistRaw) || 1;

      const bleedStack = parseNumber(document.getElementById("bleedStack").value) || 0;

      const stabDmgRaw = document.getElementById("stabDmg").value.trim();
      let stabDmg = 1;
      if (stabDmgRaw.endsWith("%")) {
        stabDmg = 1 + parseFloat(stabDmgRaw) / 100;
      } else if (stabDmgRaw !== "") {
        stabDmg = parseFloat(stabDmgRaw);
      }

      const hasBrand = document.getElementById("brand").checked;
      const hasHiddenBlade = document.getElementById("hiddenBlade").checked;

      // 표기 공격력
      const totalAtk = (baseAtk + flatAtk) * atkPercent;

      // 치명타 확률 처리
      let critRate = critRateRaw || 0;
      if (!hasHiddenBlade && critRate > 100) critRate = 100; // 숨겨진 칼날 없으면 최대 100%
      critRate = Math.min(critRate, 100);
      const critRateDecimal = critRate / 100;

      // 치명타 피해는 (2 + 치피%)
      // 치피%가 퍼센트로 입력됨
      let critDamageMultiplier = 2 + (parsePercentValue(critDmgRaw) || 0) / 100;

      // 낙인 적용
      const brandMultiplier = hasBrand ? 1.2 : 1;

      // 적중 시 피해는 상수로 취급 (마지막에 더함)
      // 퍼센트면 1+값으로 곱해서 처리하지 않고, 별도로 상수 더함

      // 스킬 피해 계산식
      // = [(기초공격력+깡공) × (1+공격력%)] × (기초스킬데미지 + 추가스킬데미지) × (1+치확%) × (2+치피%) × 낙인 × (1+저주%) × (1+감전%) × (1+추가피해%) + 적중시 피해
      const skillDamage =
        totalAtk *
        (baseSkill + bonusSkill) *
        (1 + critRateDecimal) *
        critDamageMultiplier *
        brandMultiplier *
        curse *
        shock *
        extraDmg +
        (onHitRaw.endsWith("%") ? totalAtk * onHit : onHit);

      // 기본 기술 피해 계산식
      // 위에 + (1+기본 기술 피해량 증가)
      const basicSkillDamage =
        totalAtk *
        (baseSkill + bonusSkill) *
        (1 + critRateDecimal) *
        critDamageMultiplier *
        basicSkillBoost *
        brandMultiplier *
        curse *
        shock *
        extraDmg +
        (onHitRaw.endsWith("%") ? totalAtk * onHit : onHit);

      // 출혈 피해 계산식
      // {(기초공격력 + 깡공) × (1 + 공격력%)} × 0.15 × (1 + 출혈 데미지%) × (1 + 출혈 내성%)
      const bleedDamage = totalAtk * 0.15 * bleedDmg * bleedResist;

      // 자상 피해 계산식
      // 출혈 피해 × 출혈 중첩 × 3.5 × 자상 데미지
      const stabDamage = bleedDamage * bleedStack * 3.5 * stabDmg;

      // 효율 계산 (추가되는 값 / 현재 값)
      // 예: 기본 기술 피해량 증가의 효율: basicSkillBoost / 1 (기본값)
      // 여러 효율을 따로 보여주기 위해 대입한 값들을 보여줌

      // 결과 문자열
      let resultText = `표기 공격력: ${totalAtk.toFixed(2)}\n`;
      resultText += `스킬 피해: ${skillDamage.toFixed(2)}\n`;
      resultText += `기본 기술 피해: ${basicSkillDamage.toFixed(2)}\n`;
      resultText += `출혈 피해: ${bleedDamage.toFixed(2)}\n`;
      resultText += `자상 피해: ${stabDamage.toFixed(2)}\n`;

      // 효율 계산 예시 (기본 기술 피해량 증가)
      const basicSkillEff = basicSkillBoost > 1 ? ((basicSkillBoost - 1) * 100).toFixed(2) : "0.00";
      resultText += `기본 기술 피해량 증가 효율: ${basicSkillEff}% 증가\n`;

      document.getElementById("result").textContent = resultText;

      // 계산식 및 대입값 표기
      let formulaText = "";

      formulaText += `■ 표기 공격력 = (기초공격력 + 깡공) × (1 + 공격력%)\n`;
      formulaText += `= (${baseAtk} + ${flatAtk}) × (${atkPercentRaw || "0%"} → ${atkPercent.toFixed(3)})\n`;
      formulaText += `= ${totalAtk.toFixed(2)}\n\n`;

      formulaText +=
        `■ 스킬 피해 = [표기 공격력 × (기초스킬데미지 + 추가스킬데미지) × (1 + 치명타 확률) × (2 + 치명타 피해%) × 낙인 × (1 + 저주%) × (1 + 감전%) × (1 + 추가 피해%)] + 적중시 피해\n` +
        `= ${totalAtk.toFixed(2)} × (${baseSkill} + ${bonusSkill}) × (1 + ${critRateDecimal.toFixed(3)}) × ${critDamageMultiplier.toFixed(3)} × ${brandMultiplier} × ${curse.toFixed(3)} × ${shock.toFixed(3)} × ${extraDmg.toFixed(3)} + 적중시 피해\n` +
        `= ${skillDamage.toFixed(2)}\n\n`;

      formulaText +=
        `■ 기본 기술 피해 = 스킬 피해 × (1 + 기본 기술 피해량 증가%)\n` +
        `= ${skillDamage.toFixed(2)} × ${basicSkillBoost.toFixed(3)}\n` +
        `= ${basicSkillDamage.toFixed(2)}\n\n`;

      formulaText +=
        `■ 출혈 피해 = 표기 공격력 × 0.15 × (1 + 출혈 데미지%) × (1 + 출혈 내성%)\n` +
        `= ${totalAtk.toFixed(2)} × 0.15 × ${bleedDmg.toFixed(3)} × ${bleedResist.toFixed(3)}\n` +
        `= ${bleedDamage.toFixed(2)}\n\n`;

      formulaText +=
        `■ 자상 피해 = 출혈 피해 × 출혈 중첩 × 3.5 × 자상 데미지\n` +
        `= ${bleedDamage.toFixed(2)} × ${bleedStack} × 3.5 × ${stabDmg.toFixed(3)}\n` +
        `= ${stabDamage.toFixed(2)}\n\n`;

      formulaText += `■ 기본 기술 피해량 증가 효율: ${(basicSkillEff)}% 증가 (기본값 대비)`;

      document.getElementById("formula").textContent = formulaText;
    }

    // 입력값 저장 (localStorage)
    function saveInputs() {
      const data = {
        baseAtk: document.getElementById("baseAtk").value,
        flatAtk: document.getElementById("flatAtk").value,
        atkPercent: document.getElementById("atkPercent").value,
        baseSkill: document.getElementById("baseSkill").value,
        bonusSkill: document.getElementById("bonusSkill").value,
        critRate: document.getElementById("critRate").value,
        critDmg: document.getElementById("critDmg").value,
        curse: document.getElementById("curse").value,
        shock: document.getElementById("shock").value,
        extraDmg: document.getElementById("extraDmg").value,
        onHit: document.getElementById("onHit").value,
        basicSkillBoost: document.getElementById("basicSkillBoost").value,
        bleedDmg: document.getElementById("bleedDmg").value,
        bleedResist: document.getElementById("bleedResist").value,
        bleedStack: document.getElementById("bleedStack").value,
        stabDmg: document.getElementById("stabDmg").value,
        brand: document.getElementById("brand").checked,
        hiddenBlade: document.getElementById("hiddenBlade").checked
      };
      localStorage.setItem("skillCalcData", JSON.stringify(data));
      alert("입력값이 저장되었습니다.");
    }

    // 입력값 불러오기
    function loadInputs() {
      const data = JSON.parse(localStorage.getItem("skillCalcData"));
      if (!data) {
        alert("저장된 입력값이 없습니다.");
        return;
      }
      for (const key in data) {
        if (typeof data[key] === "boolean") {
          document.getElementById(key).checked = data[key];
        } else {
          document.getElementById(key).value = data[key];
        }
      }
      alert("입력값이 불러와졌습니다.");
    }

    // 입력값 초기화
    function clearInputs() {
      const ids = [
        "baseAtk", "flatAtk", "atkPercent", "baseSkill", "bonusSkill",
        "critRate", "critDmg", "curse", "shock", "extraDmg", "onHit",
        "basicSkillBoost", "bleedDmg", "bleedResist", "bleedStack", "stabDmg"
      ];
      ids.forEach(id => (document.getElementById(id).value = ""));
      document.getElementById("brand").checked = false;
      document.getElementById("hiddenBlade").checked = false;
      document.getElementById("result").textContent = "계산 결과가 여기에 표시됩니다.";
      document.getElementById("formula").textContent = "";
    }

    // 초기화 시 저장된 데이터 자동 불러오기 (선택사항)
    window.onload = function() {
      loadInputs();
    }
  </script>
</body>
</html>
